<!DOCTYPE html>

<!--
  ~ Copyright (c) 2017. Nuvolect LLC
  ~
  ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU
  ~ General Public License as published by the Free Software Foundation, either version 3 of the License,
  ~ or (at your option) any later version.
  ~
  ~ Contact legal@nuvolect.com for a less restrictive commercial license if you would like to use the
  ~ software without the GPLv3 restrictions.
  ~
  ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
  ~ even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License along with this program.  If not,
  ~ see <http://www.gnu.org/licenses/>.
  ~
  -->

<html ng-app="myApp" ng-controller="debugController">
<head>
    <title>Developer</title>

    <script src="/js/angular.min.js"></script>
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
    <link href="/css/probe.css" rel="stylesheet">

</head>

<body>
<!-- Bootstrap core JavaScript -->
<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<div ng-include="'./navbar.htm'"></div>

<div class="container">

    <h1>Developer</h1>
    <br>

    <table align="left">

        <tr>
            <td><button ng-click="runTest('encode_hash',encode_hash_data)">Encode hash</button></td>
            <td> <input type="text" ng-model="encode_hash_data" size="50"/> </td>
            <td> Result: {{ encode_hash_result }} </td>
        </tr>
        <tr>
            <td><button ng-click="runTest('decode_hash',decode_hash_data)">Decode hash</button></td>
            <td> <input type="text" ng-model="decode_hash_data" size="50"/> </td>
            <td> Result: {{ decode_hash_result }} </td>
        </tr>
        <tr>
            <td> <button ng-click="runTest('mime', mime_data )">Mime type</button> </td>
            <td> <input type="text" ng-model="mime_data" size="50"/> </td>
            <td> Result: {{ mime_result }} </td>
        </tr>
        <tr>
            <td><button ng-click="runTest('is_reachable',is_reachable_data)">Is reachable</button></td>
            <td> <input type="text" ng-model="is_reachable_data" size="50"/> </td>
            <td>Result: {{ is_reachable_result }}</td>
        </tr>
        <tr>
            <td>
                JQuery version
            </td>
            <td>
                {{jquery_version}}
            </td>
        </tr>
        <tr>
            <td>
                AngularJS version
            </td>
            <td>
                {{angular_version}}
            </td>
        </tr>
    </table>

</div>
<div class="container">

    <h3>API</h3>

    <table align="left">

        <tr>
            <th>API</th>
            <th>Result</th>
        </tr>
        <tr>
            <td> <button ng-click="self_ip_test()">/sync/cmd=self_ip_test</button> </td>
            <td>{{ self_ip_test }}</td>
        </tr>
    </table>

</div>

<div class="container">

    <h3>Device Sync</h3>

    <table align="left">

        <tr>
            <th>Data</th>
            <th>This Device</th>
            <th>Companion Device</th>
        </tr>
        <tr>
            <td>IP:port</td>
            <td>{{ my_ip_port }}</td>
            <td>{{ companion_ip_port }}</td>
        </tr>
        <tr>
            <td>Incoming update</td>
            <td>{{ my_incoming_update }}</td>
            <td>{{ companion_incoming_update }}</td>
        </tr>
        <tr>
            <td>Outgoing update</td>
            <td>{{ my_outgoing_update }}</td>
            <td>{{ companion_outgoing_update }}</td>
        </tr>

    </table>

</div>

<br>
<br>
<div ng-include="'/footer.htm'"></div>

<script>

var app = angular.module('myApp', []);
app.controller('debugController', function($scope, $http, $parse) {

   $scope.mySyncState = function(){

       // First get data for this device, then a second call for the companion device
       $http.get("/sync?cmd=sync_state")
           .then(function (response) {
           $scope.my_ip_port = response.data.my_ip_port;
           $scope.companion_ip_port = response.data.companion_ip_port;
           $scope.my_incoming_update = response.data.incoming_update;
           $scope.my_outgoing_update = response.data.outgoing_update;

           var companion_url = "https://"+response.data.companion_ip_port;

           // Get data for the companion device
           $scope.companionSyncState( companion_url );
       });
   };

   $scope.companionSyncState = function( url ){

        $http.get( url+"/sync?cmd=sync_state")
            .then(function (response) {

            $scope.companion_incoming_update = response.data.incoming_update;
            $scope.companion_outgoing_update = response.data.outgoing_update;
        });
   };

  $scope.runTest = function( id, data ){

     $http.get("/admin?cmd=debug&test_id="+id+"&data="+data)
       .then(function (response) {

        // test_id the test name and is bound to the Angular result variable

        // Get the model
        var model = $parse(response.data.test_id+"_result");

        // Display error message if any
        var result = response.data.result;
        if( response.data.error.length > 0)
            result = response.data.error;

        // Assigns a value to it
        model.assign($scope, result);
     });
   };

  $scope.self_ip_test = function(){

     $http.get("/sync?cmd=self_ip_test&ip_port="+$scope.my_ip_port)
       .then(function (response) {

        $scope.self_ip_test = response;
     });
   };

   $scope.jquery_version = jQuery.fn.jquery;
   $scope.angular_version = angular.version.full;

   $scope.mySyncState();

});

</script>
</body>
</html>